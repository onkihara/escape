{"version":3,"file":"3-e3fd66b2.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/createhouse/_page.server.js","../../../.svelte-kit/adapter-node/nodes/3.js"],"sourcesContent":["import { r as redirect, f as fail } from \"../../../chunks/index.js\";\nimport { d as db } from \"../../../chunks/mysql.js\";\nconst createKey = function(format = \"AA000AA\", alphabet = \"ABCDEFGHJKMNPQRSTUVWXYZ\", numbers = \"0123456789\") {\n  let result = \"\";\n  for (let i = 0; i < format.length; i++) {\n    let type = format[i];\n    if (type == \"0\") {\n      result += numbers[Math.floor(Math.random() * numbers.length)].toString();\n    } else if (type == \"A\") {\n      result += alphabet[Math.floor(Math.random() * alphabet.length)].toString();\n    } else {\n      result += type;\n    }\n  }\n  return result;\n};\nasync function load({ cookies }) {\n  if (cookies.get(\"access_key\")) {\n    const data = await db.getPlayer(cookies.get(\"access_key\"));\n    if (!data.player.is_root) {\n      throw redirect(303, \"/\");\n    }\n    return data;\n  }\n  throw redirect(303, \"/\");\n}\nconst actions = {\n  default: async ({ request }) => {\n    const data = await request.formData();\n    const formdata = {};\n    for (const key of data.keys()) {\n      formdata[key] = data.get(key);\n    }\n    let validation_error = \"\";\n    if (!formdata.name) {\n      validation_error += \"<br>Name must be given\";\n    }\n    if (!formdata.number || parseInt(formdata.number) < 1) {\n      validation_error += \"<br>Number must be >= 1\";\n    }\n    if (!formdata.hash || formdata.hash.match(/[^-a-z_0-9]/g)) {\n      validation_error += \"<br>Invalid Slug\";\n    }\n    if (validation_error !== \"\") {\n      return fail(403, {\n        incorrect: true,\n        incorrect_parameter: validation_error,\n        ...formdata\n      });\n    }\n    const keys = await createHouse(formdata);\n    formdata.number = null;\n    return { success: true, keys, ...formdata };\n  }\n};\nasync function createHouse(data) {\n  const date = (/* @__PURE__ */ new Date()).toISOString().slice(0, 19).replace(\"T\", \" \");\n  const house = await db.getHouseByHash(data.hash);\n  let house_id;\n  try {\n    if (house.length > 0) {\n      house_id = house[0].id;\n    } else {\n      let query = \"INSERT INTO `houses` (`name`, `hash`, `created_at`, `updated_at`)VALUES (?,?,?,?);\";\n      const new_house = await db.runQuery(query, [data.name, data.hash, date, date]);\n      house_id = new_house.insertId;\n    }\n    return createPlayersForHouse(house_id, data.number, date);\n  } catch (e) {\n    console.log(e);\n  }\n}\nasync function createPlayersForHouse(house_id, number, date) {\n  let query = \"\";\n  const player_keys = await db.getPlayerKeysByHouse(house_id);\n  const connection = db.connect();\n  for (let i = 0; i < number; i++) {\n    let key;\n    for (let i2 = 0; i2 < 5; i2++) {\n      key = createKey();\n      if (!player_keys.includes(key)) {\n        player_keys.push(key);\n        break;\n      }\n      throw fail(403, \"No valid key available\");\n    }\n    query = \"INSERT INTO `players` (`house_id`, `key`, `role`, `rank`, `created_at`, `updated_at`)VALUES (?,?,?,?,?,?);\";\n    connection.query(query, [house_id, key, \"player\", 0, date, date], (err, results) => {\n      if (err) {\n        throw fail(403, \"Unable to create players\");\n      }\n    });\n  }\n  db.close(connection);\n  return player_keys;\n}\nexport {\n  actions,\n  load\n};\n","import * as server from '../entries/pages/createhouse/_page.server.js';\n\nexport const index = 3;\nexport const component = async () => (await import('../entries/pages/createhouse/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/createhouse/+page.server.js\";\nexport const imports = [\"_app/immutable/entry/createhouse-page.svelte.5d313b86.js\",\"_app/immutable/chunks/index.5e7f823c.js\"];\nexport const stylesheets = [];\nexport const fonts = [];\n"],"names":[],"mappings":"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"}